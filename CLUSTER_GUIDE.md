# 聚合标记功能指南

## 🎯 功能概述

聚合功能会在地图缩放级别较小或充电站数量较多时，自动将多个充电站合并显示为一个聚合标记，提升性能和可读性。

---

## ⚙️ 聚合触发条件

```javascript
聚合开启条件：
- 地图缩放级别 < 14  且
- 充电站数量 > 50

当前配置：
- 充电站总数：125个
- 默认缩放：12-13
- 结果：会自动启用聚合
```

---

## 🎨 聚合标记样式

### 圆形气泡设计

```
    ┌─────┐
    │ 35  │  ← 充电站数量（大号）
    │充电站│  ← 文字标签
    └─────┘
```

### 智能配色（根据平均空闲率）

聚合内所有充电站的平均空闲率：

| 平均空闲率 | 颜色 | 说明 |
|-----------|------|------|
| **≥50%** | 🟢 绿色 (#10b981) | 整体空闲充足 |
| **20%-49%** | 🟡 黄色 (#f59e0b) | 整体空闲紧张 |
| **<20%** | 🔴 红色 (#ef4444) | 整体几乎满载 |

### 动态尺寸

根据聚合的充电站数量自动调整大小：

| 数量范围 | 直径 | 字体大小 |
|---------|------|---------|
| 1-20个 | 50px | 18px |
| 21-50个 | 55px | 18px |
| 51-100个 | 60px | 18px |
| >100个 | 70px | 22px |

---

## 🖱️ 交互功能

### 1. 悬停效果（Hover）

```
鼠标移到聚合标记上
    ↓
标记放大到1.15倍
    ↓
阴影增强（视觉反馈）
    ↓
鼠标移开恢复原大小
```

### 2. 点击聚合

```
点击聚合标记
    ↓
地图自动放大（zoom +2）
    ↓
聚合逐步拆分
    ↓
显示更小的聚合或单个标记
```

**示例**：
- Zoom 12 → 125个站点显示为10个聚合
- 点击某个聚合（35个站点）
- Zoom 14 → 聚合拆分为35个单独标记

### 3. 持续放大

```
继续点击"+"放大
    ↓
Zoom >= 14
    ↓
所有聚合自动展开
    ↓
显示完整的单个标记（带价格和空闲数）
```

---

## 📏 聚合参数配置

```javascript
{
  gridSize: 80,          // 网格大小：80px
  minClusterSize: 5,     // 最小聚合数：5个以上才聚合
  maxZoom: 14,           // 最大聚合级别：zoom≥14不聚合
  zoomOnClick: true,     // 点击自动放大
  renderClusterMarker    // 自定义渲染函数
}
```

---

## 🎮 使用指南

### 查看聚合效果

1. **缩小地图**
   - 点击 "-" 按钮或双指缩小
   - 缩小到 zoom 10-13
   - 看到圆形聚合标记

2. **观察聚合数量**
   - 聚合标记显示数字（如"35"）
   - 下方文字"充电站"

3. **观察聚合颜色**
   - 🟢 绿色：这组充电站整体空闲充足
   - 🟡 黄色：这组充电站整体空闲紧张
   - 🔴 红色：这组充电站整体几乎满载

### 展开聚合

1. **点击聚合标记**
   - 地图自动放大
   - 聚合逐步拆分

2. **继续放大**
   - 点击 "+" 按钮
   - 或双指放大
   - Zoom >= 14 后完全展开

3. **查看单个标记**
   - 显示完整信息
   - ⚡图标 + 价格 + 空闲数

### 缩小回聚合

1. **缩小地图**
   - 点击 "-" 按钮
   - Zoom < 14

2. **自动聚合**
   - 单个标记自动合并
   - 显示聚合标记

---

## 📊 聚合示例

### Zoom 11（全市范围）

```
地图显示整个合肥市
    ↓
125个充电站显示为 8-10个聚合
    ↓
聚合标记示例：

  ┌─────┐     ┌─────┐     ┌─────┐
  │ 18  │     │ 12  │     │ 25  │
  │充电站│     │充电站│     │充电站│
  └─────┘     └─────┘     └─────┘
   绿色         黄色         绿色
```

### Zoom 13（区域范围）

```
地图显示某个区
    ↓
约50个充电站显示为 3-5个聚合
    ↓
聚合标记示例：

  ┌─────┐     ┌─────┐
  │ 15  │     │ 8   │
  │充电站│     │充电站│
  └─────┘     └─────┘
   黄色         红色
```

### Zoom 14+（街道范围）

```
地图显示街道级别
    ↓
不使用聚合，直接显示所有标记
    ↓
单个标记示例：

┌──────────────┐  ┌──────────────┐
│ ⚡ ¥1.54/度 │  │ ⚡ ¥1.48/度 │
│   6/7        │  │   2/10       │
└──────▼───────┘  └──────▼───────┘
```

---

## 🎨 聚合标记设计

### 视觉特征

1. **圆形设计**
   - 易于识别
   - 区分于单个标记（矩形卡片）

2. **数字+文字**
   - 大号数字：充电站数量
   - 小号文字："充电站"标签

3. **双层边框**
   - 内圈：3px白色边框
   - 外圈：4px半透明颜色光晕

4. **阴影效果**
   - 立体感
   - 悬停时阴影加深

### 交互反馈

- **默认**：正常大小
- **Hover**：放大1.15倍 + 阴影加深
- **Active**：缩小0.95倍（按下效果）
- **过渡**：0.2s平滑动画

---

## 📏 聚合级别

### Zoom 10-11（远距离）

```
显示：大聚合（每个包含20-40个充电站）
数量：5-8个聚合标记
尺寸：60-70px
```

### Zoom 12-13（中距离）

```
显示：中等聚合（每个包含10-20个充电站）
数量：8-15个聚合标记
尺寸：55-60px
```

### Zoom 14+（近距离）

```
显示：不聚合，单个标记
数量：所有充电站
尺寸：标准卡片大小
```

---

## 🔧 调整聚合参数

### 修改聚合阈值

在 `src/components/MapView.vue` 中修改：

```javascript
// 当前配置（第297行）
const shouldCluster = zoom < 14 && markers.value.length > 50

// 更激进的聚合（更容易触发）
const shouldCluster = zoom < 15 && markers.value.length > 30

// 更保守的聚合（不容易触发）
const shouldCluster = zoom < 13 && markers.value.length > 100
```

### 修改聚合参数

在 `updateMarkers()` 函数中（第345行）：

```javascript
new AMap.value.MarkerClusterer(map.value, [], {
  gridSize: 80,          // 网格大小（越大聚合越多）
  minClusterSize: 5,     // 最小聚合数（越小越容易聚合）
  maxZoom: 14,           // 最大聚合级别
  zoomOnClick: true,     // 点击自动放大
  renderClusterMarker: renderCluster
})
```

---

## 🧪 测试聚合功能

### 测试步骤

1. **刷新浏览器**
   ```
   Ctrl+Shift+R
   ```

2. **缩小地图到 Zoom 12**
   - 点击 "-" 按钮
   - 或双指缩小

3. **观察聚合**
   - 应该看到圆形的聚合标记
   - 显示数字和"充电站"文字
   - 不同颜色（绿/黄/红）

4. **点击聚合**
   - 地图自动放大
   - 聚合逐步拆分

5. **放大到 Zoom 14+**
   - 聚合完全展开
   - 显示单个标记

6. **再缩小**
   - 单个标记重新聚合
   - 平滑过渡

---

## 📊 性能优化

### 为什么需要聚合？

| 场景 | 不聚合 | 聚合 |
|------|--------|------|
| DOM元素 | 125个 | 8-10个 |
| 渲染性能 | 慢 | 快 |
| 可读性 | 拥挤 | 清晰 |
| 内存占用 | 高 | 低 |

### 性能对比

```
125个单独标记：
- DOM节点：125个
- 渲染时间：~50ms
- 帧率：可能卡顿

8个聚合标记：
- DOM节点：8个
- 渲染时间：~5ms
- 帧率：流畅60fps
```

---

## 🎯 聚合规则总结

| 地图缩放 | 充电站数 | 显示方式 | 说明 |
|---------|---------|---------|------|
| Zoom < 14 | >50 | 聚合显示 | 自动聚合 |
| Zoom < 14 | ≤50 | 直接显示 | 数量少不聚合 |
| Zoom ≥ 14 | 任意 | 直接显示 | 不聚合 |

---

## ✅ 当前配置

- **充电站总数**：125个
- **分布范围**：合肥市区±10km
- **分布方式**：均匀分布
- **聚合阈值**：zoom<14 且 数量>50
- **聚合参数**：
  - 网格：80px
  - 最小数：5个
  - 最大级别：14

---

## 🚀 立即测试

请 **刷新浏览器**（`Ctrl+Shift+R`），然后：

1. **缩小地图**（Zoom 11-12）
   - ✅ 看到圆形聚合标记
   - ✅ 显示数字（如"35"）和"充电站"
   - ✅ 颜色：绿/黄/红

2. **点击聚合标记**
   - ✅ 地图自动放大
   - ✅ 聚合逐步拆分

3. **放大到Zoom 14+**
   - ✅ 聚合完全展开
   - ✅ 显示单个标记（卡片样式）

4. **悬停测试**
   - ✅ 标记原地放大（不移动位置）
   - ✅ 聚合标记也原地放大

---

**请立即刷新浏览器测试聚合功能！** 🎊


