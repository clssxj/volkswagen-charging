# 充电站聚合策略文档

## 🎯 聚合策略设计

### 分层级聚合方案

| 缩放级别 | 视野内点数 | 显示策略 | 说明 |
|---------|-----------|---------|------|
| **Zoom < 13** | 任意 | 聚合显示 | 远距离视图，始终聚合 |
| **Zoom 13-15** | >50 | 聚合显示 | 中距离，标记多时聚合 |
| **Zoom 13-15** | ≤50 | 直接显示 | 中距离，标记少时直接显示 |
| **Zoom > 15** | 任意 | 直接显示 | 近距离视图，显示详细信息 |

### 聚合参数配置

```javascript
{
  gridSize: 80,          // 网格大小80px
  minClusterSize: 3,     // 最少3个标记才聚合
  maxZoom: 15,           // 缩放≥15不聚合
  zoomOnClick: true,     // 点击自动放大
  averageCenter: true,   // 聚合中心为平均位置
  renderClusterMarker    // 自定义渲染函数
}
```

---

## 🎨 聚合标记样式

### 圆形气泡设计

```
  ┌─────┐
  │ 35  │  ← 充电站数量（大号字体）
  │充电站│  ← 文字标签（小号字体）
  └─────┘
```

### 智能配色

根据聚合内所有充电站的**平均空闲率**着色：

```javascript
平均空闲率 = Σ(空闲桩数) / Σ(总桩数) × 100%

颜色映射：
- ≥50%  → 🟢 绿色 (#10b981)  整体空闲充足
- 20-49% → 🟡 黄色 (#f59e0b)  整体空闲紧张
- <20%   → 🔴 红色 (#ef4444)  整体几乎满载
```

### 动态尺寸

根据聚合的充电站数量自动调整：

```javascript
1-20个   → 50px 直径
21-50个  → 55px 直径
51-100个 → 60px 直径
>100个   → 70px 直径
```

---

## 🖱️ 交互功能

### 1. 点击聚合展开

```
用户点击聚合标记
    ↓
zoomOnClick: true 触发
    ↓
地图自动放大2个级别
    ↓
聚合重新计算
    ↓
显示更小的聚合或单个标记
```

**示例流程**：
```
Zoom 11 → 125个站点 → 显示8个大聚合
   ↓ 点击某个聚合（45个站点）
Zoom 13 → 45个站点 → 显示6个中聚合
   ↓ 点击某个聚合（8个站点）
Zoom 15 → 8个站点 → 显示8个单独标记
```

### 2. 缩放自动切换

```
用户缩小地图
    ↓
Zoom降低到12
    ↓
触发聚合逻辑
    ↓
单个标记自动合并为聚合
    ↓
平滑过渡动画
```

### 3. 单个标记信息窗

```
用户点击单个标记
    ↓
调用 showInfoWindow()
    ↓
显示气泡浮层
    ↓
内容：
- 充电站名称
- 空闲桩数徽章（带颜色）
- 价格信息
- 详细地址
- "查看详情"按钮
```

---

## 📊 缩放级别详解

### Zoom 10-12（城市级别）

**视野范围**：整个城市或大区域  
**显示效果**：
- 125个充电站全部在视野内
- 自动聚合为5-10个大聚合
- 聚合标记60-70px

**聚合示例**：
```
  ┌─────┐     ┌─────┐     ┌─────┐
  │ 45  │     │ 38  │     │ 42  │
  │充电站│     │充电站│     │充电站│
  └─────┘     └─────┘     └─────┘
   70px        60px        60px
   绿色         黄色         绿色
```

### Zoom 13-14（区域级别）

**视野范围**：市区一部分  
**显示效果**：
- 如果>50个：显示8-15个中等聚合
- 如果≤50个：直接显示单个标记

**混合显示**：
```
  ┌─────┐              ┌──────────────┐
  │ 12  │              │ ⚡ ¥1.54/度 │
  │充电站│              │   6/7        │
  └─────┘              └──────▼───────┘
  聚合(55px)            单个标记
```

### Zoom 15+（街道级别）

**视野范围**：几条街道  
**显示效果**：
- 始终直接显示
- 5-20个单独标记
- 显示完整信息

**详细标记**：
```
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ ⚡ ¥1.54/度 │  │ ⚡ ¥1.38/度 │  │ ⚡ ¥1.62/度 │
│   6/7        │  │   3/10       │  │   1/8        │
└──────▼───────┘  └──────▼───────┘  └──────▼───────┘
```

---

## 🚀 虚拟化与性能优化

### 视口过滤

```javascript
只加载和显示当前地图边界内的充电站

地图拖动/缩放
    ↓
获取新的地图边界
    ↓
从125个充电站中过滤
    ↓
只渲染可见区域的标记
```

**效果**：
- Zoom 15，小范围：只显示5-15个标记
- Zoom 12，大范围：显示80-125个标记
- 自动适应，避免过度渲染

### 防抖处理

```javascript
用户拖动地图
    ↓
触发 moveend 事件
    ↓
延迟500ms
    ↓
如果期间再次移动，重置计时器
    ↓
500ms后才加载新数据
```

**优势**：
- 避免频繁请求
- 减少重复渲染
- 提升流畅度

### 分片加载

```javascript
当前实现：
- 不一次性加载全国数据
- 只有合肥市125个充电站
- 全部预先生成，加载时过滤显示
```

---

## 🎮 使用指南

### 查看聚合效果

1. **刷新浏览器** - Ctrl+Shift+R

2. **缩小地图到Zoom 12**
   - 点击 "-" 按钮2-3次
   - 或双指缩小

3. **观察聚合标记**
   - 应该看到几个圆形标记
   - 显示数字（如"25"、"18"）
   - 不同颜色（绿/黄/红）

4. **点击聚合标记**
   - 地图自动放大
   - 聚合拆分成更小的聚合或单个标记

5. **继续放大到Zoom 15+**
   - 所有聚合完全展开
   - 显示单个卡片标记

### 测试信息窗

1. **点击任意单个标记**
   
2. **查看弹出的信息窗**
   - 充电站名称
   - 空闲状态徽章
   - 价格信息
   - 地址

3. **点击"查看详情"按钮**
   - 打开详情抽屉
   - 显示完整信息

---

## 📋 完整需求对照

### ✅ 已实现功能

#### (1) 扎点展示

- ✅ **聚合支持**：当视野内点数多时自动聚合
- ✅ **分组展示**：根据缩放级别动态调整
- ✅ **聚合图标**：圆形，显示数量和颜色
- ✅ **点击展开**：点击聚合自动放大（zoomOnClick: true）
- ✅ **信息气泡**：单点点击弹出信息窗，显示空闲/充电桩数

#### (2) 缩放与层级加载

- ✅ **动态粒度**：
  - Zoom < 13：聚合显示
  - Zoom 13-15：根据数量决定
  - Zoom > 15：直接显示详细标记
  
- ✅ **虚拟化加载**：
  - 视口过滤：只显示可见区域
  - 防抖处理：避免频繁渲染
  - 分片显示：不一次性渲染全部

---

## 🔍 调试信息

### 刷新后控制台输出

```
✓ 已生成合肥市 125 个固定充电站
✓ 返回 XXX 个充电站数据
✓ 已创建 XXX 个标记对象
✓ 当前缩放: 12, 标记数: XXX, 使用聚合: true/false

【如果使用聚合】
✓ 使用聚合模式显示 XXX 个充电站
✓ 聚合器创建成功
✓ 配置: gridSize=80, minClusterSize=3, maxZoom=15

【如果直接显示】
✓ 直接显示 XXX 个充电站标记
✓ 标记1位置: LngLat(...)
✓ 已加载 XXX/XXX 个充电站标记（直接显示）
✓ 地图上实际标记数量: XXX
```

---

## 🎯 测试场景

### 场景1：缩小到Zoom 11
- **预期**：显示聚合标记
- **聚合数**：5-10个
- **每个聚合**：包含15-30个充电站

### 场景2：点击聚合
- **预期**：地图自动放大到Zoom 13
- **效果**：聚合拆分成更小的聚合或单个标记

### 场景3：放大到Zoom 15
- **预期**：所有标记直接显示
- **显示**：卡片样式，完整信息

### 场景4：再缩小
- **预期**：单个标记重新聚合
- **效果**：平滑过渡

---

## 🛠️ 故障排查

### 如果聚合标记不显示

在控制台执行：

```javascript
// 检查聚合器对象
console.log('聚合器:', markerClusterer.value)

// 检查地图上的覆盖物
const overlays = map.getAllOverlays()
console.log('地图覆盖物:', overlays)

// 手动触发地图刷新
map.setFitView()
```

---

**请立即刷新浏览器（Ctrl+Shift+R），然后缩小地图到Zoom 11-12查看聚合效果！** 🎊


